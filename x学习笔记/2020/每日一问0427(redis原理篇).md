# redis 原理(Redis 设计与实现)
## 概念篇

### SDS
结构 ：
- 字符长度，
- 未使用空间
- 字节数组

优点:
- 常数复杂度获取字符串长度
- 杜绝缓冲区溢出
- 减少修改字符串长度时，所需的内存重分配次数
- 兼容部分C字符串函数

### SDS 内存预分配策略
为了防止 合并字符串，截取字符串造成内存重新分配带来的开销

小于1M，多分配一倍，大于1M 多分配一M （另外会多加一字节空字符标识字符结束）

### 惰性空间释放
惰性空间释放主要用于优化SDS字符串的缩短操作。不是立即释放多出来的字节，而是用free属性，将多出来的记录下来。避免了内存重分配操作，并且为将来有可能增长操作提供了优化。

### 二进制安全
C字符串必须符合某种编码(ASCll)，并且尾端不能有空字符串，这样会被认为是字符末尾，这些限制使得C字符串不能保存像图片、音视频之类的二进制数据。
SDS是采用二进制安全的(binary-safe)，处理二进制方式处理数据，怎么存的怎么取。

### 数据结构

#### 链表

#### 字典 HashMap

- 拉链法解决hash冲突（插入是头插法，因为单线程，索引没有死循环问题）
##### rehash 过程 （渐进式Rehash） 扩容
- 有 A——map 进行 rehash , 首先分配 A长度*2 的 B-Map，
- 将A值copy到 B
```aidl
渐进式Rehash 是在rehash 期间 增删改查 在两个字典上，分批次不断的copy到B Map,（增加操作只在BMap也就是新Map中）
``` 
- 将B设置为A 
- 将A 释放

#### 跳表
#### 整数集合

#### 压缩列表

### redis 过期健删除策略
可能的删除策略有 定时删除、惰性删除、定期删除
但是定时删除会抢CPU资源，惰性删除对内存不友好，所以采用 惰性删除+定期删除。

惰性删除: 所有Redis 读写命令 都会调用expireIfNeeded 函数，如果过期，先删除键，再执行下边操作。

定期随机删除: 全局变量记录检查进度，每次从一定数据数据库中随机删除。

另外 过期的键也不会写入 RDB中。

##RDB和 AOF
- RDB 全量复制 ，有阻塞和非阻塞 两种 ，非阻塞是新开子进程，进行复制。
- AOF 是 增量复制
