# redis 原理(Redis 设计与实现)
## 概念篇

### SDS
结构 ：
- 字符长度，
- 未使用空间
- 字节数组

优点:
- 常数复杂度获取字符串长度
- 杜绝缓冲区溢出
- 减少修改字符串长度时，所需的内存重分配次数
- 兼容部分C字符串函数

### SDS 内存预分配策略
为了防止 合并字符串，截取字符串造成内存重新分配带来的开销

小于1M，多分配一倍，大于1M 多分配一M （另外会多加一字节空字符标识字符结束）

### 惰性空间释放
惰性空间释放主要用于优化SDS字符串的缩短操作。不是立即释放多出来的字节，而是用free属性，将多出来的记录下来。避免了内存重分配操作，并且为将来有可能增长操作提供了优化。

### 二进制安全
C字符串必须符合某种编码(ASCll)，并且尾端不能有空字符串，这样会被认为是字符末尾，这些限制使得C字符串不能保存像图片、音视频之类的二进制数据。
SDS是采用二进制安全的(binary-safe)，处理二进制方式处理数据，怎么存的怎么取。

### 数据结构

#### 链表

#### 字典 HashMap

- 拉链法解决hash冲突（插入是头插法，因为单线程，索引没有死循环问题）
##### rehash 过程 （渐进式Rehash） 扩容
- 有 A——map 进行 rehash , 首先分配 A长度*2 的 B-Map，
- 将A值copy到 B
```aidl
渐进式Rehash 是在rehash 期间 增删改查 在两个字典上，分批次不断的copy到B Map,（增加操作只在BMap也就是新Map中）
```
- 将B设置为A 
- 将A 释放

#### 跳表

多级索引，遍历链表

如果一个有序集合包含的**元素数量比较多**,又或者有序集合中元素的**成员是比较长的字符串**时, Redis就会使用跳跃表来作为有序集合健的底层实现。

![跳跃表](https://hunter-image.oss-cn-beijing.aliyuncs.com/redis/skiplist/%E8%B7%B3%E8%B7%83%E8%A1%A8.png)



- 跳跃表基于单链表加索引的方式实现
- 跳跃表以空间换时间的方式提升了查找速度
- Redis有序集合在节点元素较大或者元素数量较多时使用跳跃表实现
- Redis的跳跃表实现由 zskiplist和 zskiplistnode两个结构组成,其中 zskiplist用于保存跳跃表信息(比如表头节点、表尾节点、长度),而zskiplistnode则用于表示跳跃表节点
- Redis每个跳跃表节点的层高都是1至32之间的随机数
- 在同一个跳跃表中,多个节点可以包含相同的分值,但每个节点的成员对象必须是唯一的跳跃表中的节点按照分值大小进行排序,当分值相同时,节点按照成员对象的大小进行排序。

#### 整数集合

- 整数集合是Redis自己设计的一种存储结构,集合键的底层实现之一。
- 整数集合的底层实现为数组,这个数组以有序、无重复的方式保存集合元素,在有需要时,程序会根据新添加元素的类型,改变这个数组的类型。
- 升级操作为整数集合带来了操作上的灵活性,并且尽可能地节约了内存。
- 整数集合只支持升级操作,不支持降级操作。

#### 压缩列表

### redis 过期健删除策略
可能的删除策略有 定时删除、惰性删除、定期删除
但是定时删除会抢CPU资源，惰性删除对内存不友好，所以采用 惰性删除+定期删除。

惰性删除: 所有Redis 读写命令 都会调用expireIfNeeded 函数，如果过期，先删除键，再执行下边操作。

定期随机删除: 全局变量记录检查进度，每次从一定数据数据库中随机删除。

另外 过期的键也不会写入 RDB中。

##RDB和 AOF
- RDB 全量复制 ，有阻塞和非阻塞 两种 ，非阻塞是新开子进程，进行复制。
- AOF 是 增量复制

1. Redis 默认开启RDB持久化方式，在指定的时间间隔内，执行指定次数的写操作，则将内存中的数据写入到磁盘中。
2. RDB 持久化适合大规模的数据恢复但它的数据一致性和完整性较差。
3. Redis 需要手动开启AOF持久化方式，默认是每秒将写操作日志追加到AOF文件中。
4. AOF 的数据完整性比RDB高，但记录内容多了，会影响数据恢复的效率。
5. Redis 针对 AOF文件大的问题，提供重写的瘦身机制。
6. 若只打算用Redis 做缓存，可以关闭持久化。
7. 若打算使用Redis 的持久化。建议RDB和AOF都开启。其实RDB更适合做数据的备份，留一后手。AOF出问题了，还有RDB。

## 参考

[redis结构-整数集合](https://www.cnblogs.com/hunternet/p/11268067.html)