# 数据库

## 数据库概念

图灵机指出了数据的3个核心需求：1、数据存储；2、数据写入；3、数据读取。

一个标准的数据库大概主要会包含以下几个大的模块。[出处](https://juejin.im/post/578bbd5e6be3ff006cdfe0f9)

```$xslt
1. 底层的`存储层`，这个是必不可少的，他是整个数据库的核心数据结构，也就是数据是如何保存的，一般提供最简单的原子增删改查。
2. 存储层上面就是`引擎层`了，这里会对底层的存储层进行各种组合型的操作用来满足查询的需求之类的，而且数据库的事务支持也在这一层，我们熟悉的`innoDB`就是一个数据库的存储引擎，`他其实包含的就是这个引擎层和存储层`了，引擎层提供对数据层的操作方法集合。
3. 在引擎层之上还有个`SQL的解析层`，主要用来对SQL语句进行解析，分析，优化了，然后把SQL语句转化成引擎层的接口，进行具体的数据操作。
4. 最上面就是对外的UI了，也就是用户`交互层`了，一般我们熟悉的就是网络交互了。
```

### 为什么用数据库呢？
其实要保存数据，搜索系统也能保存数据，而且检索起来更快，并且两者的底层数据结构其实差别不是很大，``但为什么用数据库呢？``因为数据库的核心是`可靠`，这个可靠就是考数据库的引擎层来保证的，完整的`binlog`记录，`崩溃后完整的重放机制`，`数据双写`，`内存数据定时刷新到磁盘`，所有的这些都是为了保证数据的可靠，不会丢失数据。

另一个就是`性能`，为了避免全表扫描，就得创建索引， 为了建立索引，关系型数据库 一般是 实现`B+树`来存储索引，用`逆波兰表达式`来对WHERE之后的语句进行解析;时序数据库 实现 `LSM tree` ``核心思想``就是通过内存写和后续磁盘的顺序写入获得更高的写入性能，避免了随机写入。但同时也牺牲了读取性能

 参考[MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html) 和[每日一问0801](每日一问0801(树).md)




## 数据库类型

根据存储模型划分，数据库类型主要可分为:
```$xslt
 网状数据库(Network Database)、(淘汰或者咱们用不到)
 关系数据库(Relational Database)、(mysql,pg,oricle)
 层次(树形)数据库(Hierarchical Database)、(淘汰或者咱们用不到)
 面向对象数据库(Object-oriented Database)(非关系型数据库？)(nosql,mongledb)。
```

非关系型数据库的优势：

```$xslt
1. 性能高：NOSQL是基于键值对的，可以想象成表中的主键和值的对应关系，而且不需要经过SQL层的解析，所以性能非常高。
2. 可扩展性好：同样也是因为基于键值对，数据之间没有耦合性，所以非常容易水平扩展。
```

关系型数据库的优势：

```$xslt
1. 可以复杂查询：可以用SQL语句方便的在一个表以及多个表之间做非常复杂的数据查询。
2. 事务支持良好：使得对于安全性能很高的数据访问要求得以实现。
```

### 数据库的应用类型
  数据库的应用类型分为 OLTP（Online Transaction Processing ，即联机事务处理）和 OLAP（Online Analysis Processing，即联机分析处理）两种。

* OLTP 是传统关系型数据库的主要应用，其主要面向基本的、日常的事务处理，例如在线交易。它的基本特征是可以立即将客户端的原始数据传送到计算中心进行处理，并且在很短的时间内给出处理结果。衡量 OLTP 系统的一个重要性能指标是系统性能，具体体现为实时响应时间（Response Time），即从用户在终端输入数据到计算机对这个请求做出回复所需的时间。

* OLAP 是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。OLAP 专门用于支持复杂的分析操作，侧重对决策人员和高层管理人员的决策支持，可以根据分析人员的要求快速、灵活地进行大数据量的复杂查询处理，并且以一种直观易懂的形式将查询结果提供给决策人员。为了让用户从多个角度切换或者进行多角度综合分析，OLAP 数据库通常使用一个或多个多维数据集（Multi Dimensional Dataset），并且使用 MDX（Multi Dimensional Expressions，即多维表达式）进行数据定义和操作。

一个是反馈，一个是显示结果，帮助分析。

###### SQL 中包括3类语言：
```
 DML（Data Manipulation Language，即数据操纵语言） 增删改查
 DDL（Data Definition Language，即数据定义语言）主要的命令有 CREATE、ALTER、DROP 等。
 DCL（Data Control Language，即数据控制语言）权限相关 包括 Grant、Deny、Revoke 等语句。
 ```

[时序数据库？](./每日一问0825(时序数据库).md)

## mysql ,pg,mongodb,es ,hbase 区别 ，优点
参考 

* [“王者对战”之 MySQL 8 vs PostgreSQL 10](https://www.oschina.net/translate/showdown-mysql-8-vs-postgresql-10)
* [数据库对比](http://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94)

对比mysql 和 pg
一个多进程堆索引,一个多线程聚簇索引

|           | mysql                 | pg                                        |
|-----------|-----------------------|-------------------------------------------|
|  背后和协议    | oracle 这样成熟商业公司 \(BSD/MIT \) | 强大开源志愿者 \(GPL或Commercial License\)|                                                   
| SQL标准的支持  | 只支持部分SQL标准|几乎支持所有的SQL标准 |    	                                                                                                                                                                                                                                                                                                                                                            |
| 数据流转优势    | 所有的高可用方案都是基于binlog做的同步，以及基于MySQL的分布式数据也是基于MySQL的binlog实现  (`异步`)                                                                                                                                                      | `可以做到同步，异步`，半同步复制，以及基于日志逻辑复制，可以实现表级别的订阅和发布。                                                                                                                                                                                                                  |
| ACID支持方面  | MySQL只有innodb引擎支持事务，事务一致性保证上可根据实际需求调整，为了最大限度的保护数据，MySQL可配置双一模式，对ACID的支持上比PG稍弱弱。                                                                                                                                                         | 支持事务的强一致性，事务保证性好，完全支持ACID特性。                                                                                                                                                                                                                               |
| 性能        | ① MySQL是广泛选择的基于Web的项目，需要数据库只是为了简单的数据事务。 但是，当遇到重负载或尝试完成复杂查询时，MySQL通常会表现不佳。<br>② MySQL的读取速度，在OLTP系统中表现良好。<br>③ MySQL \+ InnoDB为OLTP场景提供了非常好的读/写速度。总体而言，MySQL在高并发场景下表现良好。<br>            ④ MySQL是可靠的，并且与商业智能应用程序配合良好，因为商业智能应用程序通常读取很多。<br> | ①PostgreSQL广泛用于读写速度高和数据一致性高的大型系统。此外，它还支持各种性能优化，<br>当然这些优化仅在商业解决方案中可用，例如地理空间数据支持，没有读锁定的并发性等等。 <br> ② PostgreSQL性能最适用于需要执行复杂查询的系统。<br>  ③ PostgreSQL在OLTP/ OLAP系统中表现良好，读写速度以及大数据分析方面表现良好，基于PG的GP数据库，在数据仓库领域表现良好。<br>  ④ PostgreSQL也适用于商业智能应用程序，但更适合需要快速读/写速度的数据仓库和数据分析应用程序。 |
| 数据存储和数据类型 | MySQL采用索引组织表，MySQL必须有主键索引，所有的数据访问都是通过主键实现，<br>二级索引访问时，需要扫描两遍索引（主键和二级索引）                                                                                                                                                                     | PG主表采用堆表存放，存放的数据量较大，数据访问方式类似于Oracle的堆表。                                                                                                                                                                                                                    |                                                                                                                          


| 特性   | MySQL 8                       | PostgreSQL 10     |
|------|-------------------------------|-------------------|
| 架构   | 单进程                           | 多进程               |
| 并发   | 多线程                           | fork\(2\)         |
| 表结构  |  聚簇索引                         | 堆                 |
| 页压缩  | Transparent                   | TOAST             |
| 更新   | In\-Place / Rollback Segments | Append Only / HOT |
| 垃圾回收 | 清除线程                          | 自动清空进程            |
| 事务日志 | REDO Log \(WAL\)              | WAL               |
| 复制日志 | Separate \(Binlog\)           | WAL               |


补充一下协议类型说明: ![avatar](http://5b0988e595225.cdn.sohucs.com/images/20180912/1fae01494506483785a820a1464f6163.jpeg)

#### PostgreSQL与MySQL优劣对比总结

PostgreSQL相对于MySQL的优势

```$xslt
1、在SQL的标准实现上要比MySQL完善，而且功能实现比较严谨；
2、存储过程的功能支持要比MySQL好，具备本地缓存执行计划的能力；
3、对表连接支持较完整，优化器的功能较完整，支持的索引类型很多，复杂查询能力较强；
4、PG主表采用堆表存放，MySQL采用索引组织表，能够支持比MySQL更大的数据量。
5、PG的主备复制属于物理复制，相对于MySQL基于binlog的逻辑复制，数据的一致性更加可靠，复制性能更高，对主机性能的影响也更小。
6、MySQL的存储引擎插件化机制，存在锁机制复杂影响并发的问题，而PG不存在。
7、PG对可以实现外部数据源查询，数据源的支持类型丰富。
8、PG原生的逻辑复制可以实现表级别的订阅发布，可以实现数据通过kafka流转，而不需要其他的组件。
9、PG支持三种表连接方式，嵌套循环，哈希连接，排序合并，而MySQL只支持嵌套循环。
10、 PostgreSQL源代码写的很清晰，易读性比MySQL强太多了。
11、 PostgreSQL通过PostGIS扩展支持地理空间数据。 地理空间数据有专用的类型和功能，可直接在数据库级别使用，使开发人员更容易进行分析和编码。
12、可扩展型系统，有丰富可扩展组件，作为contribute发布。
13、 PostgreSQL支持JSON和其他NoSQL功能，如本机XML支持和使用HSTORE的键值对。 它还支持索引JSON数据以加快访问速度，特别是10版本JSONB更是强大。
14、 PostgreSQL完全免费，而且是BSD协议，如果你把PostgreSQL改一改，然后再拿去卖钱，也没有人管你，这一点很重要，这表明了PostgreSQL数据库不会被其它公司控制。 相反，MySQL现在主要是被Oracle公司控制。
```


MySQL相对于PG的优势

```
   1、innodb的基于回滚段实现的MVCC机制，相对PG新老数据一起存放的基于XID的MVCC机制，是占优的。新老数据一起存放，需要定时触 发VACUUM，会带来多余的IO和数据库对象加锁开销，引起数据库整体的并发能力下降。而且VACUUM清理不及时，还可能会引发数据膨胀；
   2、MySQL采用索引组织表，这种存储方式非常适合基于主键匹配的查询、删改操作，但是对表结构设计存在约束；
   3、MySQL的优化器较简单，系统表、运算符、数据类型的实现都很精简，非常适合简单的查询操作；
   4、MySQL相对于PG在国内的流行度更高，PG在国内显得就有些落寞了。
   5、MySQL的存储引擎插件化机制，使得它的应用场景更加广泛，比如除了innodb适合事务处理场景外，myisam适合静态数据的查询场景。
```

总结: 数据量大这俩差不多

mysql 和 mongodb 对比
这基本上是关系型和菲关系型对比

表格待出

总结 ：

MongoDB的应用场景
1. `表结构不明确`且数据不断变大 MongoDB是非结构化文档数据库，扩展字段很容易且不会影响原有数据。内容管理或者博客平台等，例如`圈子系统，存储用户评论`之类的。 
2. ``更高的写入负载`` MongoDB侧重`高数据写入的性能`，而非事务安全，适合业务系统中有大量“`低价值`”数据的场景。本身存的就是json格式数据。例如做`日志系统`。 
3. 数据量很大或者将来会变得很大 
Mysql单表数据量达到5-10G时会出现明细的性能降级，需要做数据的水平和垂直拆分、库的拆分完成扩展，`MongoDB内建了sharding`、很多数据分片的特性，容易水平扩展，比较好的适应大数据量增长的需求。 
4. 高可用性 
自带高可用，自动主从切换（副本集)

不适用的场景 
1. MongoDB`不支持事务操作`，需要用到事务的应用建议不用MongoDB。 
2. MongoDB目前`不支持join`操作，需要复杂查询的应用也不建议使用MongoDB。

#### ES对比Mysql
![avatar](https://img-blog.csdnimg.cn/20190415104445378.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Jvc2h5,size_16,color_FFFFFF,t_70)


### 为啥选 es

